name: "PR"

on:
  push:
    branches:
      - "main"
  pull_request:
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:

  fmt:
    name: "Run cargo fmt"
    runs-on: warp-ubuntu-latest-x64-4x
    steps:
      - name: "Checkout sources"
        uses: "actions/checkout@v4"

      - name: "Setup nightly toolchain"
        uses: "actions-rs/toolchain@v1"
        with:
          toolchain: "nightly"
          profile: "minimal"
          components: "rustfmt"
          override: true

      - name: "Check Rust format"
        run: |
          cargo fmt --all -- --check

  Build:
    name: "Build Reva"
    runs-on: warp-custom-big-disk
    steps:
      - name: "Checkout sources"
        uses: "actions/checkout@v4"

      - name:  "remove default rust"
        run: |     
          rustup self uninstall -y

      - name: Install Rust nightly toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly
          components: clippy

      - name: "Read Valida version"
        id: valida-version
        run: |
          VALIDA_VERSION=$(cat valida-version-pin.txt)
          echo "version=$VALIDA_VERSION" >> $GITHUB_OUTPUT

      - name: "Download Valida binary release"
        run: |
          wget -nv https://github.com/lita-xyz/valida-releases/releases/latest/download/llvm-valida-${{ steps.valida-version.outputs.version }}-linux-x86_64.tar.xz

      - name: "Install Valida"
        run: |
          mkdir -p /home/runner/.local/bin
          tar -xf llvm-valida-${{ steps.valida-version.outputs.version }}-linux-x86_64.tar.xz
          cd ./valida-toolchain
          sudo ./install.sh
          rustup toolchain link valida /valida-toolchain

      - name: "Build Reva"
        run: |
          cd bin/host
          cargo +valida build --target=x86_64-unknown-linux-gnu

      - name: "Build eth-client"
        run: |
          cd bin/eth-client
          cargo +valida build

      - name: "Run Reva Tests"
        run: |
          ./scripts/test-client.sh
